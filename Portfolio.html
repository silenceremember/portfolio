<!DOCTYPE html>
<html>
<head>
    <title>Physical Ball</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #1a1a1a;
        }
        
        #ball {
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, #ffffff, #ff4444);
            border-radius: 50%;
            position: absolute;
            box-shadow: inset -5px -5px 15px rgba(0,0,0,0.3);
        }
        
        #info {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            font-family: Arial, sans-serif;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
        }

        #ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
        }

        .debug-info {
            color: #666;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="ball"></div>
    <div id="ground"></div>
    <div id="info">
        Управление:<br>
        ← → или A/D - движение влево/вправо<br>
        ↑ или W - прыжок с земли<br>
        ↓ или S (удерживать) - быстрое падение<br>
        Скорость: <span id="speed">0</span> px/s<br>
        На земле: <span id="grounded">да</span>
        <div class="debug-info">
            Расстояние до земли: <span id="groundDistance">0</span>px<br>
            Время между приземлениями: <span id="airTime">0</span>ms
        </div>
    </div>

    <script>
        // Константы физики
        const PHYSICS = {
            MOVE_FORCE: 0.8,
            MAX_MOVE_SPEED: 15,
            JUMP_FORCE: -18,
            GRAVITY: 0.6,
            FAST_FALL_MULT: 2.5,
            GROUND_FRICTION: 0.95,
            AIR_RESISTANCE: 0.98,
            BOUNCE_FORCE: 0.5,
            WALL_BOUNCE: 0.4,
            MIN_BOUNCE_SPEED: 4,
            GROUND_STICK_FORCE: 0.8,
            GROUND_CHECK_THRESHOLD: 1
        };

        // Состояние игры
        const gameState = {
            pos: { x: 100, y: 100 },
            vel: { x: 0, y: 0 },
            isGrounded: false,
            lastGroundStartTime: 0,   // Когда последний раз приземлились
            lastGroundEndTime: 0,     // Когда последний раз оторвались от земли
            timeBetweenLandings: 0,   // Время между последними приземлениями
            lastTimeBetweenLandings: 0, // Предыдущее время между приземлениями
            keys: new Set()
        };

        // DOM элементы
        const elements = {
            ball: document.getElementById('ball'),
            speedDisplay: document.getElementById('speed'),
            groundedDisplay: document.getElementById('grounded'),
            groundDistanceDisplay: document.getElementById('groundDistance'),
            airTimeDisplay: document.getElementById('airTime')
        };

        // Обработчики ввода
        class InputHandler {
            static init() {
                window.addEventListener('keydown', e => {
                    const key = e.key.toLowerCase();
                    gameState.keys.add(key);
                    if(['arrowup', 'arrowdown', 'arrowleft', 'arrowright', ' '].includes(key)) {
                        e.preventDefault();
                    }
                });

                window.addEventListener('keyup', e => {
                    gameState.keys.delete(e.key.toLowerCase());
                });
            }

            static isPressed(key) {
                return gameState.keys.has(key);
            }

            static isMovingLeft() {
                return this.isPressed('arrowleft') || this.isPressed('a');
            }

            static isMovingRight() {
                return this.isPressed('arrowright') || this.isPressed('d');
            }

            static isJumping() {
                return this.isPressed('arrowup') || this.isPressed('w');
            }

            static isFastFalling() {
                return this.isPressed('arrowdown') || this.isPressed('s');
            }
        }

        // Физический движок
        class Physics {
            static updatePosition(dt) {
                gameState.pos.x += gameState.vel.x * dt;
                gameState.pos.y += gameState.vel.y * dt;
            }

            static applyGravity(dt) {
                if (InputHandler.isFastFalling() && !gameState.isGrounded) {
                    gameState.vel.y += PHYSICS.GRAVITY * PHYSICS.FAST_FALL_MULT;
                } else {
                    gameState.vel.y += PHYSICS.GRAVITY * dt;
                }
            }

            static handleMovement(dt) {
                if (InputHandler.isMovingLeft()) {
                    gameState.vel.x -= PHYSICS.MOVE_FORCE * dt;
                }
                if (InputHandler.isMovingRight()) {
                    gameState.vel.x += PHYSICS.MOVE_FORCE * dt;
                }

                // Ограничение скорости
                gameState.vel.x = Math.min(Math.max(gameState.vel.x, -PHYSICS.MAX_MOVE_SPEED), PHYSICS.MAX_MOVE_SPEED);

                // Трение
                gameState.vel.x *= gameState.isGrounded ? PHYSICS.GROUND_FRICTION : PHYSICS.AIR_RESISTANCE;
            }

            static handleJump() {
                if (InputHandler.isJumping() && gameState.isGrounded) {
                    gameState.vel.y = PHYSICS.JUMP_FORCE;
                    gameState.isGrounded = false;
                    const now = Date.now();
                    gameState.lastGroundEndTime = now;
                }
            }

            static updateLandingTimes(now, wasGrounded) {
                // Обработка приземления
                if (!wasGrounded && gameState.isGrounded) {
                    gameState.lastGroundStartTime = now;
                    
                    // Если у нас есть предыдущее время отрыва от земли
                    if (gameState.lastGroundEndTime > 0) {
                        // Сохраняем предыдущий интервал
                        gameState.lastTimeBetweenLandings = gameState.timeBetweenLandings;
                        // Вычисляем новый интервал между приземлениями
                        gameState.timeBetweenLandings = now - gameState.lastGroundEndTime;
                    }
                }
                
                // Обработка отрыва от земли
                if (wasGrounded && !gameState.isGrounded) {
                    gameState.lastGroundEndTime = now;
                }
            }

            static handleCollisions(windowWidth, windowHeight, ballSize) {
                const groundY = windowHeight - ballSize;
                const now = Date.now();
                const wasGrounded = gameState.isGrounded;

                // Коллизия с землёй
                if (gameState.pos.y > groundY) {
                    gameState.pos.y = groundY;
                    
                    if (!InputHandler.isFastFalling() && Math.abs(gameState.vel.y) > PHYSICS.MIN_BOUNCE_SPEED) {
                        gameState.vel.y = -Math.abs(gameState.vel.y * PHYSICS.BOUNCE_FORCE);
                        gameState.isGrounded = false;
                    } else {
                        gameState.vel.y = 0;
                        gameState.isGrounded = true;
                    }
                } else {
                    gameState.isGrounded = Math.abs(gameState.pos.y - groundY) <= PHYSICS.GROUND_CHECK_THRESHOLD;
                }

                this.updateLandingTimes(now, wasGrounded);

                // Коллизия с потолком
                if (gameState.pos.y < 0) {
                    gameState.pos.y = 0;
                    gameState.vel.y = Math.abs(gameState.vel.y * PHYSICS.BOUNCE_FORCE);
                }

                // Коллизия со стенами
                if (gameState.pos.x < 0) {
                    gameState.pos.x = 0;
                    gameState.vel.x = Math.abs(gameState.vel.x * PHYSICS.WALL_BOUNCE);
                }
                if (gameState.pos.x > windowWidth - ballSize) {
                    gameState.pos.x = windowWidth - ballSize;
                    gameState.vel.x = -Math.abs(gameState.vel.x * PHYSICS.WALL_BOUNCE);
                }
            }
        }

        // Обновление UI
        class UI {
            static update() {
                const speed = Math.sqrt(gameState.vel.x ** 2 + gameState.vel.y ** 2);
                elements.speedDisplay.textContent = Math.round(speed * 10) / 10;
                elements.groundedDisplay.textContent = gameState.isGrounded ? 'да' : 'нет';
                elements.groundDistanceDisplay.textContent = 
                    Math.round(window.innerHeight - gameState.pos.y - 50);
                elements.airTimeDisplay.textContent = Math.round(gameState.timeBetweenLandings);
            }
        }

        // Основной игровой цикл
        function gameLoop() {
            const dt = 1;
            const ballSize = 50;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            Physics.handleMovement(dt);
            Physics.handleJump();
            Physics.applyGravity(dt);
            Physics.updatePosition(dt);
            Physics.handleCollisions(windowWidth, windowHeight, ballSize);

            // Обновление позиции мяча
            elements.ball.style.transform = `translate(${gameState.pos.x}px, ${gameState.pos.y}px)`;

            UI.update();
            requestAnimationFrame(gameLoop);
        }

        // Инициализация
        function init() {
            InputHandler.init();
            window.addEventListener('resize', () => {
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                const ballSize = 50;

                if (gameState.pos.x > windowWidth - ballSize) {
                    gameState.pos.x = windowWidth - ballSize;
                }
                if (gameState.pos.y > windowHeight - ballSize) {
                    gameState.pos.y = windowHeight - ballSize;
                }
            });

            gameLoop();
        }

        init();
    </script>
</body>
</html>